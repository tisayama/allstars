# Token Rotation Procedure

**Feature**: 001-projector-auth
**Document Version**: 1.0.0
**Last Updated**: 2025-11-16

## Overview

This document describes the procedure for rotating authentication credentials for the projector-app, including API keys and Firebase custom tokens. Token rotation is a critical security practice for maintaining unattended operation security.

## Credential Types

### 1. API Key (`VITE_PROJECTOR_API_KEY`)
- **Location**: `apps/projector-app/.env`
- **Purpose**: Authenticates projector-app to API server for custom token generation
- **Lifetime**: No expiration (rotate periodically for security)
- **Impact of Rotation**: Projector-app cannot fetch new tokens until config updated

### 2. Firebase Custom Token
- **Generated By**: API server (`customTokenService`)
- **Lifetime**: 1 hour (automatically refreshed by `useProjectorAuth`)
- **Impact of Rotation**: Automatically handled, no manual intervention

## When to Rotate

### Scheduled Rotation
- **API Key**: Every 90 days (recommended)
- **Reason**: Proactive security best practice

### Emergency Rotation
Rotate immediately if:
- ✅ API key compromised or leaked
- ✅ Suspicious authentication attempts in audit logs
- ✅ Employee with key access leaves organization
- ✅ Development environment exposed to public
- ✅ Security audit recommendation

## API Key Rotation Procedure

### Prerequisites
- Access to api-server configuration
- Access to projector-app deployment environment
- Ability to restart projector-app

### Step 1: Generate New API Key

```bash
# Generate a secure random API key (32 characters recommended)
openssl rand -base64 32
# Example output: aBcDeFgHiJkLmNoPqRsTuVwXyZ0123456789+/==
```

**Important**: Save this key securely - you'll need it for both api-server and projector-app.

### Step 2: Update API Server Configuration

#### Option A: Environment Variable (Production)

1. Add new key to api-server environment:
```bash
# In api-server deployment environment
export PROJECTOR_API_KEY_NEW="<new-key-from-step-1>"
```

2. Update api-server validation to accept BOTH old and new keys temporarily:
```typescript
// apps/api-server/src/middleware/apiKeyAuth.ts
const validKeys = [
  process.env.PROJECTOR_API_KEY,      // Old key
  process.env.PROJECTOR_API_KEY_NEW   // New key (temporary)
];

if (!validKeys.includes(providedKey)) {
  // Reject request
}
```

3. Deploy api-server with dual-key support

#### Option B: Direct Update (Development)

```bash
# In apps/api-server/.env
PROJECTOR_API_KEY=<new-key-from-step-1>
```

### Step 3: Update Projector-App Configuration

**CRITICAL**: Never commit API keys to version control!

#### Production Deployment

1. Update environment configuration:
```bash
# In projector-app deployment environment
VITE_PROJECTOR_API_KEY=<new-key-from-step-1>
```

2. Rebuild projector-app:
```bash
cd apps/projector-app
pnpm run build
```

3. Deploy new build

#### Development Environment

```bash
# In apps/projector-app/.env
VITE_PROJECTOR_API_KEY=<new-key-from-step-1>
```

### Step 4: Verify New Key Works

1. Restart projector-app
2. Monitor console for successful authentication:
```
[Auth] Token refresh scheduled in 3300s
```

3. Check api-server audit logs for successful token generation:
```
[AUDIT] TOKEN_GENERATED { uid: "projector-...", expiresAt: ... }
```

4. Verify connection status shows green indicator

### Step 5: Remove Old Key

**Wait Period**: Wait 24-48 hours to ensure all projector instances updated

After waiting period:

1. Remove old key from api-server:
```bash
# Remove PROJECTOR_API_KEY_NEW from environment
unset PROJECTOR_API_KEY_NEW
```

2. Update middleware to use only new key:
```typescript
// apps/api-server/src/middleware/apiKeyAuth.ts
const validKey = process.env.PROJECTOR_API_KEY;
if (providedKey !== validKey) {
  // Reject request
}
```

3. Deploy api-server

### Step 6: Document Rotation

Update rotation log:
```markdown
## Rotation History

| Date       | Type     | Reason              | Performed By |
|------------|----------|---------------------|--------------|
| 2025-11-16 | API Key  | Scheduled (90 days) | Admin Name   |
```

## Rollback Procedure

If new key causes issues:

### Quick Rollback (< 24 hours)

1. Re-enable old key in api-server:
```bash
export PROJECTOR_API_KEY=<old-key>
```

2. Restart api-server

3. Old projector-app instances will resume working

### Full Rollback (> 24 hours)

1. Follow rotation procedure again with old key as "new" key
2. Update all projector-app instances
3. Remove failed key from api-server

## Security Best Practices

### Key Storage

✅ **DO**:
- Store keys in environment variables
- Use secret management systems (AWS Secrets Manager, Azure Key Vault)
- Restrict access to production credentials
- Use different keys for development/staging/production

❌ **DON'T**:
- Commit keys to version control
- Share keys via email or chat
- Use same key across environments
- Store keys in client-side code (except `VITE_*` which is acceptable for API keys)

### Key Generation

✅ **DO**:
- Use cryptographically secure random generation
- Generate keys with 32+ characters
- Use alphanumeric + special characters

❌ **DON'T**:
- Use predictable patterns
- Reuse keys from other systems
- Use short keys (< 16 characters)

### Monitoring

Monitor audit logs for:
- Failed authentication attempts with old keys
- Unusual token generation patterns
- Multiple auth failures from same IP

```bash
# Check for failed auth attempts
grep "AUTH_FAILED" api-server.log | grep "Invalid API key"
```

## Troubleshooting

### Projector Can't Authenticate After Rotation

**Symptoms**:
- Red connection status
- Error: "Failed to fetch custom token: 401"

**Solution**:
1. Verify new API key in projector-app `.env`
2. Verify projector-app was rebuilt after env change
3. Check api-server logs for API key validation errors
4. Verify api-server has new key in environment

### API Server Rejecting Valid Key

**Symptoms**:
- Audit log shows `AUTH_FAILED` with correct key prefix
- 401 responses from `/api/projector/auth-token`

**Solution**:
1. Verify environment variable loaded: `echo $PROJECTOR_API_KEY`
2. Check for trailing whitespace in key
3. Verify api-server restarted after env change
4. Check middleware code for validation logic

### Dual-Key Period Issues

**Symptoms**:
- Some projectors work, some don't

**Solution**:
1. Verify BOTH old and new keys in api-server validation
2. Check which key each projector is using (audit logs)
3. Update lagging projectors to new key

## Emergency Contact

For security incidents related to key compromise:
1. Immediately rotate keys (skip wait period)
2. Review audit logs for suspicious activity
3. Contact security team
4. Document incident timeline

## Automation (Future Enhancement)

Consider implementing:
- Automated key rotation every 90 days
- Key expiration warnings in audit logs
- Notification system for rotation due dates
- API for programmatic key updates

## References

- [OWASP Key Management Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Key_Management_Cheat_Sheet.html)
- [Firebase Custom Token Documentation](https://firebase.google.com/docs/auth/admin/create-custom-tokens)
- Feature Spec: `/specs/001-projector-auth/spec.md`
- Audit Logging: `/apps/api-server/src/services/auditLogger.ts`

---

**Document Maintained By**: Development Team
**Review Schedule**: Every 6 months or after security incident
