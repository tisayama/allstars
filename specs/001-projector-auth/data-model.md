# Data Model: Projector-App WebSocket Authentication

**Feature**: 001-projector-auth
**Created**: 2025-11-16
**Source**: [spec.md](./spec.md)

## Overview

This document defines the data entities, structures, and relationships for the projector-app WebSocket authentication system. The model supports service account-based authentication with custom tokens, dedicated WebSocket namespaces, and connection state management.

## Core Entities

### 1. ProjectorAuthToken

**Purpose**: Server-generated custom token for projector authentication

**Structure**:
```typescript
interface ProjectorAuthToken {
  token: string;              // Firebase custom token (JWT)
  expiresAt: number;          // Unix timestamp (token valid for 1 hour)
  uid: string;                // Unique identifier for this projector instance
  role: 'projector';          // Fixed role for authorization
}
```

**Validation Rules**:
- `token`: Must be valid Firebase custom token format (JWT)
- `expiresAt`: Must be future timestamp (now + 3600000ms)
- `uid`: Must follow pattern `projector-{uuid}` or `projector-{venue-id}`
- `role`: Must always be `'projector'` (enforced by generator)

**State Transitions**:
```
[Not Exists] → [Generated] → [Used] → [Expired]
                    ↓           ↓
                [Revoked] ← [Revoked]
```

**Lifecycle**:
- **Generated**: Created by API server when projector requests token
- **Used**: Token used to sign in to Firebase Auth
- **Expired**: Token validity period (1 hour) has elapsed
- **Revoked**: Token manually invalidated (not implemented in MVP)

---

### 2. ProjectorSession

**Purpose**: Active WebSocket connection for a projector instance

**Structure**:
```typescript
interface ProjectorSession {
  sessionId: string;          // Socket.IO socket.id
  uid: string;                // Firebase UID from token claims
  role: 'projector';          // Verified from token custom claims
  connectedAt: number;        // Unix timestamp of connection
  lastHeartbeat: number;      // Last activity timestamp
  metadata: ProjectorMetadata;
}

interface ProjectorMetadata {
  venueId?: string;           // Optional venue identifier
  displayType?: 'primary' | 'backup' | 'dj';  // Display purpose
  userAgent: string;          // Browser/device info
  ipAddress: string;          // Connection origin (for audit)
}
```

**Validation Rules**:
- `sessionId`: Non-empty string (generated by Socket.IO)
- `uid`: Must match Firebase UID from verified token
- `role`: Must be `'projector'` (verified from custom claims)
- `connectedAt`: Must be <= current timestamp
- `lastHeartbeat`: Must be >= connectedAt

**Relationships**:
- One `ProjectorAuthToken` → One `ProjectorSession` (per connection attempt)
- One projector instance can have multiple sessions over time
- Multiple simultaneous sessions allowed (different displays at same venue)

---

### 3. AuthenticationConfiguration

**Purpose**: Environment configuration for authentication credentials

**Structure**:
```typescript
interface AuthenticationConfiguration {
  // Server-side (api-server, socket-server)
  firebaseProjectId: string;
  firebasePrivateKey: string;       // Service account private key
  firebaseClientEmail: string;      // Service account email

  // Client-side (projector-app)
  apiBaseUrl: string;               // API server URL for token endpoint
  projectorApiKey: string;          // Static key for /api/projector/auth-token
  socketServerUrl: string;          // WebSocket server URL
  socketNamespace: '/projector-socket';  // Fixed namespace
}
```

**Source**: Environment variables
- Server: `FIREBASE_PROJECT_ID`, `FIREBASE_PRIVATE_KEY`, `FIREBASE_CLIENT_EMAIL`
- Client: `VITE_API_BASE_URL`, `VITE_PROJECTOR_API_KEY`, `VITE_SOCKET_SERVER_URL`

**Validation Rules**:
- All URLs must be valid HTTP/HTTPS URLs
- `projectorApiKey`: Minimum 32 characters (secure random string)
- `firebasePrivateKey`: Valid RSA private key format
- No service account credentials exposed in client bundle

**Security Constraints**:
- Service account credentials MUST NEVER be in Vite environment variables
- `VITE_*` variables are public (bundled into client JavaScript)
- Service account JSON files MUST be in `.gitignore`

---

### 4. ConnectionStatus

**Purpose**: UI state for displaying connection status to venue staff

**Structure**:
```typescript
type ConnectionState = 'disconnected' | 'authenticating' | 'connected' | 'error';

interface ConnectionStatus {
  state: ConnectionState;
  message: string;              // User-friendly status message
  lastConnected?: number;       // Timestamp of last successful connection
  errorDetails?: string;        // Error message (if state === 'error')
  retryAttempt?: number;        // Current retry attempt (1-10)
  nextRetryIn?: number;         // Milliseconds until next retry
}
```

**State Transitions**:
```
[disconnected] → [authenticating] → [connected]
       ↑              ↓                  ↓
       └─────────[error]←────────────────┘
                   ↓
              (retry after delay)
```

**Display Mapping** (FR-006, SC-005):
- `disconnected`: Red status bar, "WebSocket: 切断"
- `authenticating`: Yellow status bar with pulse, "認証中..."
- `connected`: Green status bar, "WebSocket: 接続済"
- `error`: Red status bar, error message (e.g., "認証失敗：設定を確認してください")

---

## API Request/Response Models

### Token Generation Request

**Endpoint**: `POST /api/projector/auth-token`

**Request**:
```typescript
interface TokenGenerationRequest {
  // No body required
}

// Headers
{
  'X-API-Key': string;  // VITE_PROJECTOR_API_KEY
  'Content-Type': 'application/json'
}
```

**Response** (Success):
```typescript
interface TokenGenerationResponse {
  token: string;        // Firebase custom token
  expiresAt: number;    // Expiration timestamp
  uid: string;          // Generated UID for this projector
}
```

**Response** (Error):
```typescript
interface TokenGenerationError {
  error: string;        // Error code
  message: string;      // Human-readable message
  statusCode: number;   // HTTP status code
}
```

**Status Codes**:
- `200 OK`: Token generated successfully
- `401 Unauthorized`: Invalid or missing API key
- `429 Too Many Requests`: Rate limit exceeded (10 requests/minute per IP)
- `500 Internal Server Error`: Firebase Admin SDK error

**Rate Limiting**:
- 10 token generations per minute per IP address
- Prevents abuse while allowing legitimate reconnections

---

### WebSocket Authentication Message

**Event**: `AUTH_REQUIRED` (server → client)

**Payload**:
```typescript
interface AuthRequiredPayload {
  timeout: number;  // Milliseconds to provide token (10000ms)
}
```

**Event**: `authenticate` (client → server)

**Payload**:
```typescript
interface AuthenticatePayload {
  token: string;    // Firebase ID token from signInWithCustomToken
}
```

**Event**: `authenticated` (server → client)

**Payload**:
```typescript
interface AuthenticatedPayload {
  sessionId: string;
  uid: string;
  message: string;
}
```

**Event**: `AUTH_FAILED` (server → client)

**Payload**:
```typescript
interface AuthFailedPayload {
  reason: string;
  code: 'INVALID_TOKEN' | 'EXPIRED_TOKEN' | 'TIMEOUT' | 'INVALID_ROLE';
}
```

---

## Audit Log Model

### AuthenticationAttemptLog

**Purpose**: Security audit trail for all projector authentication attempts (FR-007)

**Structure**:
```typescript
interface AuthenticationAttemptLog {
  timestamp: number;            // Unix timestamp
  uid: string;                  // Projector UID
  event: 'TOKEN_REQUESTED' | 'TOKEN_GENERATED' | 'AUTH_SUCCESS' | 'AUTH_FAILED';
  outcome: 'success' | 'failure';
  ipAddress: string;            // Source IP
  userAgent: string;            // Browser info
  errorCode?: string;           // If outcome === 'failure'
  errorMessage?: string;        // Human-readable error
  metadata?: Record<string, any>;  // Additional context
}
```

**Storage**: Server logs (structured JSON format for log aggregation)

**Retention**: 90 days minimum (security audit requirement)

**Alert Triggers** (FR-007):
- 3+ consecutive failures from same IP → Administrator alert
- Token generation rate > 60/minute → Rate limit alert
- Authentication with revoked token → Security alert

---

## Validation Schema (Zod)

### Token Generation Response Validation

```typescript
import { z } from 'zod';

export const TokenGenerationResponseSchema = z.object({
  token: z.string().min(100),  // JWT tokens are typically 200+ chars
  expiresAt: z.number().int().positive(),
  uid: z.string().regex(/^projector-[a-f0-9-]+$/),
});

export const TokenGenerationErrorSchema = z.object({
  error: z.string(),
  message: z.string(),
  statusCode: z.number().int().min(400).max(599),
});
```

### WebSocket Auth Payload Validation

```typescript
export const AuthenticatePayloadSchema = z.object({
  token: z.string().min(100),  // Firebase ID token
});

export const AuthenticatedPayloadSchema = z.object({
  sessionId: z.string(),
  uid: z.string(),
  message: z.string(),
});

export const AuthFailedPayloadSchema = z.object({
  reason: z.string(),
  code: z.enum(['INVALID_TOKEN', 'EXPIRED_TOKEN', 'TIMEOUT', 'INVALID_ROLE']),
});
```

---

## Edge Case Data Handling

### Missing/Malformed Configuration (Edge Case from spec.md:62)

**Scenario**: `VITE_PROJECTOR_API_KEY` not set or empty

**Behavior**:
```typescript
interface ConfigurationError {
  state: 'error';
  message: '設定エラー：API Keyが設定されていません';
  canRetry: false;  // Configuration error requires manual intervention
}
```

**Display**: Red status bar with configuration error message, no retry attempts

---

### Socket Server Not Ready (Edge Case from spec.md:60)

**Scenario**: Projector-app starts before socket-server is available

**Behavior**:
- Initial connection attempt fails with `ECONNREFUSED`
- Exponential backoff retry begins: 1s → 2s → 4s → ... → 60s
- After 10 attempts (~5 minutes), enter degraded mode
- Display last known game state with red "切断" status

**State**:
```typescript
{
  state: 'error',
  message: 'サーバーに接続できません',
  retryAttempt: 7,
  nextRetryIn: 32000,  // 32 seconds until next attempt
}
```

---

### Network Interruption > Several Minutes (Edge Case from spec.md:61)

**Scenario**: Network interruption lasting 10+ minutes

**Behavior**:
- Socket.IO automatically attempts reconnection (10 attempts)
- Before each reconnection, refresh Firebase ID token if expired
- If all retries exhausted, stay in degraded mode
- Continue periodic retry every 60 seconds indefinitely

**Token Refresh Logic**:
```typescript
interface TokenRefreshState {
  lastRefresh: number;
  tokenExpiresAt: number;
  needsRefresh: boolean;  // true if (now + 300000) > tokenExpiresAt
}
```

**Rationale**: Prevents authentication failures due to expired tokens during long network outages

---

## Performance Considerations

### Connection Establishment SLA (SC-001)

**Target**: < 5 seconds from app launch to connected state

**Breakdown**:
1. Firebase initialization: ~500ms
2. API call for custom token: ~200ms (local dev), ~500ms (prod)
3. signInWithCustomToken: ~300ms
4. WebSocket connection: ~100ms
5. Authentication verification: ~100ms

**Total**: ~1.2s (dev), ~1.5s (prod) → **Well within 5s target**

### Reconnection SLA (SC-002)

**Target**: < 3 seconds when connection restored

**Breakdown**:
1. Socket.IO reconnection: ~100ms
2. Token refresh (if needed): ~500ms
3. Re-authentication: ~100ms

**Total**: ~700ms (no refresh), ~1.2s (with refresh) → **Within 3s target**

---

## Data Storage

**Note**: This feature does NOT introduce new persistent storage entities. All data is ephemeral:

- **ProjectorAuthToken**: Exists only in memory (API response, 1-hour lifetime)
- **ProjectorSession**: Exists only in Socket.IO server memory (connection lifetime)
- **ConnectionStatus**: React state in projector-app (app lifetime)
- **AuthenticationAttemptLog**: Server logs (stdout/file, not database)

No Firestore documents, no SQL tables required.

---

## Migration Notes

**From**: Current projector-app using Firebase anonymous authentication
**To**: Custom token-based authentication with dedicated namespace

**Breaking Changes**:
1. WebSocket connection URL changes from `/` to `/projector-socket`
2. Authentication flow changes from anonymous auth to custom token
3. New environment variable required: `VITE_PROJECTOR_API_KEY`

**Migration Steps**:
1. Deploy new API endpoint `/api/projector/auth-token` to api-server
2. Deploy `/projector-socket` namespace to socket-server
3. Update projector-app `.env` with `VITE_PROJECTOR_API_KEY`
4. Deploy updated projector-app with new authentication flow
5. Remove old anonymous auth code after validation

**Rollback Plan**:
- Keep old namespace `/` active during migration period
- Projector-app can fall back to anonymous auth if custom token fails
- Gradual rollout with feature flag
