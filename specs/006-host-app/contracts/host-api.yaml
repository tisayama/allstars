openapi: 3.0.0
info:
  title: AllStars Host Control API
  description: API for wedding quiz host control panel to advance game state
  version: 1.0.0
  contact:
    name: AllStars Development Team
servers:
  - url: http://localhost:5001/allstars-dev/us-central1
    description: Local Firebase Emulator
  - url: https://us-central1-allstars-prod.cloudfunctions.net
    description: Production Firebase Functions

paths:
  /host/game/advance:
    post:
      summary: Advance game state by triggering an action
      description: |
        Processes a host action (START_QUESTION, SHOW_DISTRIBUTION, etc.) and updates
        the gameState/live Firestore document. Only authorized hosts can invoke this endpoint.

        The API validates the action is appropriate for the current game phase and rejects
        invalid transitions (e.g., cannot SHOW_RESULTS when phase is ready_for_next).

        After successful processing, the gameState/live document is updated, triggering
        real-time listeners in all connected host-app, participant-app, and projector-app clients.
      operationId: advanceGame
      security:
        - FirebaseAuth: []
      tags:
        - Host Control
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/HostActionRequest'
            examples:
              startQuestion:
                summary: Start a new question
                value:
                  action: START_QUESTION
                  payload:
                    questionId: q-first-half-001
              showDistribution:
                summary: Show answer distribution
                value:
                  action: SHOW_DISTRIBUTION
              triggerGong:
                summary: Activate final question gong
                value:
                  action: TRIGGER_GONG
      responses:
        '200':
          description: Action processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HostActionResponse'
              examples:
                success:
                  summary: Successful action
                  value:
                    success: true
        '400':
          description: Bad request - invalid action for current phase or invalid payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HostActionResponse'
              examples:
                invalidPhase:
                  summary: Action not valid for current phase
                  value:
                    success: false
                    message: "Invalid action SHOW_DISTRIBUTION for current phase ready_for_next"
                missingPayload:
                  summary: Required payload missing
                  value:
                    success: false
                    message: "Action START_QUESTION requires payload.questionId"
        '401':
          description: Unauthorized - invalid or missing Firebase ID token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                unauthorized:
                  summary: Missing or invalid auth token
                  value:
                    success: false
                    message: "Unauthorized: Invalid Firebase ID token"
        '403':
          description: Forbidden - authenticated user is not authorized as host
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                forbidden:
                  summary: User not authorized as host
                  value:
                    success: false
                    message: "Forbidden: User is not registered as an authorized host"
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                serverError:
                  summary: Unexpected server error
                  value:
                    success: false
                    message: "Internal server error processing action"

components:
  schemas:
    HostActionRequest:
      type: object
      required:
        - action
      properties:
        action:
          type: string
          enum:
            - START_QUESTION
            - SHOW_DISTRIBUTION
            - SHOW_CORRECT_ANSWER
            - SHOW_RESULTS
            - TRIGGER_GONG
            - REVIVE_ALL
            - ready_for_next
          description: |
            The game action to execute. Each action triggers a specific phase transition:
            - START_QUESTION: ready_for_next → accepting_answers (requires payload.questionId)
            - SHOW_DISTRIBUTION: accepting_answers → showing_distribution
            - SHOW_CORRECT_ANSWER: showing_distribution → showing_correct_answer
            - SHOW_RESULTS: showing_correct_answer → showing_results
            - TRIGGER_GONG: accepting_answers → accepting_answers (sets isGongActive=true)
            - REVIVE_ALL: any phase → all_revived → ready_for_next
            - ready_for_next: showing_results → ready_for_next (or all_revived → ready_for_next)
        payload:
          type: object
          description: Action-specific data (required for START_QUESTION)
          properties:
            questionId:
              type: string
              description: Unique question identifier (required when action=START_QUESTION)
              example: q-first-half-001
          additionalProperties: true
      example:
        action: START_QUESTION
        payload:
          questionId: q-first-half-001

    HostActionResponse:
      type: object
      required:
        - success
      properties:
        success:
          type: boolean
          description: True if action processed successfully, false if error
        message:
          type: string
          description: Error message when success=false (omitted when success=true)
          example: "Invalid action for current phase"
      example:
        success: true

    ErrorResponse:
      type: object
      required:
        - success
        - message
      properties:
        success:
          type: boolean
          enum: [false]
          description: Always false for error responses
        message:
          type: string
          description: Human-readable error message
          example: "Unauthorized: Invalid Firebase ID token"
        code:
          type: string
          description: Machine-readable error code (optional)
          example: "INVALID_TOKEN"

  securitySchemes:
    FirebaseAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Firebase ID token obtained from Firebase Authentication.
        The token must be from a Google-authenticated user registered as an authorized host.

        To obtain the token:
        1. Sign in with Firebase Auth using Google provider
        2. Call `user.getIdToken()` to retrieve the JWT
        3. Include in Authorization header: `Bearer <token>`

        Token expiration: ~1 hour (Firebase auto-refreshes)

tags:
  - name: Host Control
    description: Endpoints for wedding quiz host control panel

externalDocs:
  description: AllStars Platform Documentation
  url: https://github.com/tisayama/allstars/tree/main/docs
